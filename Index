import React, { useMemo, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  Bell,
  BookOpen,
  Calendar,
  ChevronDown,
  Filter,
  Flame,
  Hash,
  Heart,
  Home,
  MessageCircle,
  Plus,
  Search,
  Shield,
  Sparkles,
  Star,
  TrendingUp,
  User,
  Users,
  WifiOff,
  RotateCcw,
} from "lucide-react";

// Shadcn UI
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";

/**
 * ì„œíŠ¹ì˜(ì„œìš¸ì‹œ íŠ¹ì´ëŠ¥ë ¥ ì˜ì¬í•™êµ) ì»¤ë®¤ë‹ˆí‹° â€” MVP+ (ë‹¨ì¼ íŒŒì¼)
 *
 * âœ… í¬í•¨ ê¸°ëŠ¥
 * - ê²Œì‹œíŒ/ê³µì§€/ì¼ì •/ê¸‰ì‹/ìµëª…
 * - ê¸€ì“°ê¸°(ì„œë²„ ì €ì¥), ìƒì„¸ ëª¨ë‹¬, ëŒ“ê¸€(ì„œë²„ ì €ì¥/ì¡°íšŒ), ì¢‹ì•„ìš” í† ê¸€
 * - ì„œë²„ ë‹¤ìš´ ì‹œ ì˜¤í”„ë¼ì¸(ëª©ì—…) ëª¨ë“œ ì „í™˜ + ìƒë‹¨ ë°°ë„ˆ
 *
 * âš ï¸ "Failed to fetch"ëŠ” ì‹¤í–‰ í™˜ê²½(ìƒŒë“œë°•ìŠ¤/CSP) ë˜ëŠ” URL/ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ.
 */

const CATEGORIES = [
  { key: "all", label: "ì „ì²´", icon: Home },
  { key: "notice", label: "ê³µì§€", icon: Bell },
  { key: "schedule", label: "ì¼ì •", icon: Calendar },
  { key: "cafeteria", label: "ê¸‰ì‹", icon: Flame },
  { key: "free", label: "ì¡ë‹´", icon: MessageCircle },
  { key: "confession", label: "ìµëª…ê³ ë°±", icon: Heart },
  { key: "battle", label: "í›ˆë ¨/ì „íˆ¬", icon: Shield },
  { key: "club", label: "ë™ì•„ë¦¬", icon: Users },
  { key: "wiki", label: "ë„ê°/ìœ„í‚¤", icon: BookOpen },
];

// âœ… API_BASE (ê°™ì€ ì˜¤ë¦¬ì§„ ì§€ì›)
// - Apps Script Web Appì—ì„œ í”„ë¡ íŠ¸ë¥¼ ê°™ì´ ì„œë¹™í•˜ë©´, í˜„ì¬ í˜ì´ì§€ URLì´ ê³§ API ì—”ë“œí¬ì¸íŠ¸(/exec)ì…ë‹ˆë‹¤.
// - ë¡œì»¬/ê¹ƒí—™ ë“± ì™¸ë¶€ì—ì„œ í…ŒìŠ¤íŠ¸í•  ë• FALLBACK_URLë¡œ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
const FALLBACK_URL =
  "https://script.google.com/macros/s/AKfycbx5vxkFz6hTgNJSzYr5nP_UEiX37gGDRDC5s8eWMjIHEfaxBuUO20CtSYdFHH4-XRlf/exec";

function getApiBase() {
  if (typeof window !== "undefined") {
    try {
      const u = new URL(window.location.href);
      const host = u.hostname || "";
      const isAppsScriptHost = host.endsWith("script.google.com");
      if (isAppsScriptHost) {
        u.hash = "";
        u.search = "";
        // /dev(í…ŒìŠ¤íŠ¸) â†’ /exec(ë°°í¬)ë¡œ ì •ê·œí™”
        if (u.pathname.endsWith("/dev")) {
          u.pathname = u.pathname.replace(/\/dev$/, "/exec");
        }
        return u.toString();
      }
    } catch {
      // ignore
    }
  }
  return FALLBACK_URL;
}

// ì‚¬ìš©ìê°€ ì§ì ‘ API URLì„ ë°”ê¾¸ê³  ì‹¶ì„ ìˆ˜ ìˆì–´ localStorage override ì§€ì›
const API_OVERRIDE_KEY = "srt_api_base";
function getApiBaseWithOverride() {
  if (typeof window !== "undefined") {
    const saved = window.localStorage?.getItem(API_OVERRIDE_KEY);
    if (saved && saved.startsWith("https://script.google.com/macros/s/")) return saved;
  }
  return getApiBase();
}

const API_BASE = getApiBaseWithOverride();

// -------------------- ë„¤íŠ¸ì›Œí¬ í—¬í¼(íƒ€ì„ì•„ì›ƒ/ì˜¤í”„ë¼ì¸ ì „í™˜) --------------------
function buildUrl(path, params = {}) {
  const url = new URL(API_BASE);
  url.searchParams.set("path", path);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, String(v)));
  return url.toString();
}

async function fetchWithTimeout(url, options = {}, timeoutMs = 9000) {
  const ctrl = new AbortController();
  const id = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    return await fetch(url, { ...options, signal: ctrl.signal });
  } finally {
    clearTimeout(id);
  }
}

async function apiGetSafe(path, params = {}) {
  const url = buildUrl(path, params);
  try {
    const res = await fetchWithTimeout(url, {}, 9000);
    const data = await res.json();
    return { ok: true, data, _url: url };
  } catch (err) {
    return {
      ok: false,
      error: err instanceof Error ? err.message : String(err),
      _network: true,
      _url: url,
    };
  }
}

async function apiPostSafe(path, payload = {}) {
  const url = buildUrl(path);
  try {
    const res = await fetchWithTimeout(
      url,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      },
      9000
    );
    const data = await res.json();
    return { ok: true, data, _url: url };
  } catch (err) {
    return {
      ok: false,
      error: err instanceof Error ? err.message : String(err),
      _network: true,
      _url: url,
    };
  }
}

// -------------------- ëª©ì—… ë°ì´í„°(ì„œë²„ ì‹¤íŒ¨ ì‹œ fallback) --------------------
const SEED_POSTS = [
  {
    id: "p1",
    category: "notice",
    title: "[ê³µì§€] 7êµì‹œ ì‹¤ì „í‰ê°€ ì•ˆë‚´",
    body: "ì „ì› ì°¸ì—¬. ì¥ë¹„/ì œì–´ê¸° ì ê²€ í•„ìˆ˜. ì´ìƒ ìˆ˜ì¹˜ ë°œìƒ ì‹œ ì¦‰ê° ë³´ê³ .",
    author: "í•™ìƒíšŒ",
    anonymous: false,
    createdAt: "ì˜¤ëŠ˜ 08:12",
    tags: ["ì‹¤ì „í‰ê°€", "í•„ì°¸"],
    likes: 18,
    comments: 6,
    pinned: true,
    liked: false,
  },
  {
    id: "p2",
    category: "cafeteria",
    title: "ê¸‰ì‹ ì‹¤í™”ëƒâ€¦ ì˜¤ëŠ˜ ì¹˜í‚¨",
    body: "ë°”ì‚­í•¨ ì ìˆ˜ 9/10. êµ­ì€ ë¬´ë‚œ. ë””ì €íŠ¸ëŠ” ì•½ê°„ ì•„ì‰¬ì›€.",
    author: "ë£¨ì¹´âš¡",
    anonymous: false,
    createdAt: "ì˜¤ëŠ˜ 08:26",
    tags: ["ê¸‰ì‹"],
    likes: 42,
    comments: 21,
    pinned: false,
    liked: false,
  },
];

const SEED_CHAT = [
  { id: "c1", who: "ë£¨ì¹´âš¡", text: "ì•¼ ì˜¤ëŠ˜ ê¸‰ì‹ ã„¹ã…‡ ë¯¸ì³¤ë‹¤", at: "08:27" },
  { id: "c2", who: "ìµëª…", text: "ì „í•™ìƒ ì†Œë¬¸ ë­ì„?", at: "08:29" },
  { id: "c3", who: "ë¯¸ë ˆë‚˜â™¡", text: "ì¡°ìš©â€¦ ê·¼ë° ìœ„ìƒì„  í”ë“¤ë¦¼ ëŠê»´ì¡Œì–´", at: "08:30" },
  { id: "c4", who: "ì•„ì´ë¦¬ìŠ¤âœ¨", text: "ì¡ë‹´ì€ ì‰¬ëŠ” ì‹œê°„ì—. ê³µì§€ í™•ì¸ ë¶€íƒí•´ìš”", at: "08:32" },
];

// -------------------- Utils --------------------
function cx(...classes) {
  return classes.filter(Boolean).join(" ");
}

function normalizePost(p) {
  const id = p.id || p.postId || "";
  const tags = Array.isArray(p.tags)
    ? p.tags
    : typeof p.tags === "string"
      ? p.tags
          .split(",")
          .map((t) => t.trim())
          .filter(Boolean)
      : [];

  return {
    id,
    category: p.category,
    title: p.title,
    body: p.body,
    author: p.author ?? p.authorName ?? "ìµëª…",
    anonymous: !!p.anonymous,
    createdAt: p.createdAt ?? "",
    updatedAt: p.updatedAt ?? "",
    pinned: !!p.pinned,
    likes: Number(p.likes || 0),
    comments: Number(p.comments || 0),
    liked: !!p.liked,
    tags,
  };
}

// ê°„ë‹¨ ëŸ°íƒ€ì„ í…ŒìŠ¤íŠ¸(ê°œë°œìš©). ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ìœ ì§€ + 1ê°œ ì¶”ê°€
if (typeof window !== "undefined") {
  console.assert(cx("a", false, "b") === "a b", "cx() should join truthy strings");
  const np = normalizePost({ postId: "x", tags: "a, b" });
  console.assert(np.id === "x" && np.tags.length === 2, "normalizePost() should map postId/tags");
  console.assert(
    typeof API_BASE === "string" && API_BASE.includes("/exec"),
    "API_BASE should be a string and ideally end with /exec (Apps Script Web App URL)"
  );
  console.assert(
    buildUrl("/health").includes("path=%2Fhealth") || buildUrl("/health").includes("path=/health"),
    "buildUrl() should include the path query param"
  );
  // ì¶”ê°€ í…ŒìŠ¤íŠ¸: normalizePost tags ë°°ì—´ ìœ ì§€
  const np2 = normalizePost({ id: "y", tags: ["x", "y"] });
  console.assert(np2.id === "y" && np2.tags.length === 2, "normalizePost() should keep tag arrays");
}

function Pill({ children }) {
  return (
    <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs text-muted-foreground">
      {children}
    </span>
  );
}

function StatChip({ icon: Icon, label, value }) {
  return (
    <div className="flex items-center gap-2 rounded-2xl border px-3 py-2">
      <Icon className="h-4 w-4" />
      <div className="text-xs text-muted-foreground">{label}</div>
      <div className="text-sm font-semibold">{value}</div>
    </div>
  );
}

function CategoryItem({ cat, active, onClick }) {
  const Icon = cat.icon;
  return (
    <button
      onClick={onClick}
      className={cx(
        "flex w-full items-center gap-2 rounded-2xl px-3 py-2 text-left transition",
        active ? "bg-primary text-primary-foreground" : "hover:bg-muted text-foreground",
      )}
    >
      <Icon className="h-4 w-4" />
      <span className="text-sm font-medium">{cat.label}</span>
    </button>
  );
}

function OfflineBanner({ status, lastError, lastUrl, onRetry }) {
  if (status !== "down") return null;
  const currentApi = API_BASE;

  const setOverride = () => {
    const v = prompt("API URLì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš” (/execë¡œ ëë‚˜ëŠ” Web App URL)", currentApi);
    if (!v) return;
    if (!v.startsWith("https://script.google.com/macros/s/")) {
      alert("Apps Script Web App URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
      return;
    }
    localStorage.setItem(API_OVERRIDE_KEY, v);
    location.reload();
  };

  const clearOverride = () => {
    localStorage.removeItem(API_OVERRIDE_KEY);
    location.reload();
  };

  return (
    <div className="border-b bg-muted/40">
      <div className="mx-auto flex max-w-7xl items-center gap-3 px-4 py-2 text-sm">
        <WifiOff className="h-4 w-4" />
        <div className="min-w-0">
          <div className="font-medium">ì„œë²„ ì—°ê²° ì‹¤íŒ¨ â†’ ì˜¤í”„ë¼ì¸(ëª©ì—…) ëª¨ë“œë¡œ ë™ì‘ ì¤‘</div>
          <div className="text-xs text-muted-foreground break-all">
            {lastError ? `ì—ëŸ¬: ${lastError}` : ""}
            {lastUrl ? ` Â· URL: ${lastUrl}` : ""}
          </div>
        </div>
        <div className="ml-auto flex items-center gap-2">
          <Button variant="outline" className="rounded-2xl" onClick={setOverride}>
            API ì„¤ì •
          </Button>
          <Button variant="outline" className="rounded-2xl" onClick={clearOverride}>
            ì´ˆê¸°í™”
          </Button>
          <Button variant="outline" className="rounded-2xl" onClick={onRetry}>
            <RotateCcw className="mr-2 h-4 w-4" /> ì¬ì‹œë„
          </Button>
        </div>
      </div>
    </div>
  );
}

function PostCard({ post, onOpen }) {
  return (
    <motion.div layout>
      <Card
        className={cx(
          "rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer",
          post.pinned && "border-primary/40",
        )}
        onClick={() => onOpen(post)}
      >
        <CardHeader className="pb-2">
          <div className="flex items-start justify-between gap-3">
            <div className="min-w-0">
              <div className="flex items-center gap-2">
                {post.pinned && (
                  <Badge variant="default" className="rounded-full">
                    ê³ ì •
                  </Badge>
                )}
                <Badge variant="secondary" className="rounded-full">
                  {CATEGORIES.find((c) => c.key === post.category)?.label ?? post.category}
                </Badge>
              </div>
              <CardTitle className="mt-2 line-clamp-2 text-base">{post.title}</CardTitle>
              <div className="mt-1 flex flex-wrap items-center gap-2 text-xs text-muted-foreground">
                <span>{post.anonymous ? "ìµëª…" : post.author}</span>
                <span>â€¢</span>
                <span>{post.createdAt}</span>
                {post.tags?.slice(0, 2).map((t) => (
                  <Pill key={t}>#{t}</Pill>
                ))}
              </div>
            </div>
            <ChevronDown className="h-4 w-4 opacity-30" />
          </div>
        </CardHeader>
        <CardContent className="pt-0">
          <p className="line-clamp-2 text-sm text-muted-foreground">{post.body}</p>
          <div className="mt-4 flex items-center gap-4 text-xs text-muted-foreground">
            <span className="inline-flex items-center gap-1">
              <Heart className="h-4 w-4" /> {post.likes}
            </span>
            <span className="inline-flex items-center gap-1">
              <MessageCircle className="h-4 w-4" /> {post.comments}
            </span>
            <span className="ml-auto inline-flex items-center gap-1">
              <TrendingUp className="h-4 w-4" /> HOT
            </span>
          </div>
        </CardContent>
      </Card>
    </motion.div>
  );
}

function PostModal({ open, onOpenChange, post, token, serverStatus, onRefreshPost, onServerDown }) {
  const [comments, setComments] = useState([]);
  const [loading, setLoading] = useState(false);
  const [commentText, setCommentText] = useState("");
  const [commentAnon, setCommentAnon] = useState(false);
  const [likeBusy, setLikeBusy] = useState(false);

  React.useEffect(() => {
    let mounted = true;
    (async () => {
      if (!open || !post?.id) return;
      if (serverStatus !== "up") {
        setComments([]);
        return;
      }
      setLoading(true);
      try {
        const r = await apiGetSafe(`/posts/${post.id}/comments`, { token: token || "" });
        if (!mounted) return;
        if (!r.ok) {
          onServerDown?.(r);
          setComments([]);
          return;
        }
        const data = r.data;
        if (data?.ok && Array.isArray(data.comments)) setComments(data.comments);
        else setComments([]);
      } finally {
        if (mounted) setLoading(false);
      }
    })();
    return () => {
      mounted = false;
    };
  }, [open, post?.id, token, serverStatus, onServerDown]);

  const sendComment = async () => {
    if (!token) return;
    const t = commentText.trim();
    if (!t || !post?.id) return;
    if (serverStatus !== "up") return;

    const r = await apiPostSafe(`/posts/${post.id}/comments`, {
      token,
      body: t,
      anonymous: commentAnon,
    });
    if (!r.ok) {
      onServerDown?.(r);
      return;
    }
    if (r.data?.ok) {
      setCommentText("");
      const rr = await apiGetSafe(`/posts/${post.id}/comments`, { token });
      if (rr.ok && rr.data?.ok && Array.isArray(rr.data.comments)) setComments(rr.data.comments);
      onRefreshPost?.();
    }
  };

  const togglePostLike = async () => {
    if (!token || !post?.id || likeBusy) return;
    if (serverStatus !== "up") return;
    setLikeBusy(true);
    try {
      const r = await apiPostSafe("/likes/toggle", {
        token,
        targetType: "post",
        targetId: post.id,
      });
      if (!r.ok) {
        onServerDown?.(r);
        return;
      }
      if (r.data?.ok) onRefreshPost?.();
    } finally {
      setLikeBusy(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl rounded-2xl">
        <DialogHeader>
          <DialogTitle className="text-lg">{post?.title ?? "ê²Œì‹œê¸€"}</DialogTitle>
        </DialogHeader>

        {post && (
          <div className="space-y-4">
            <div className="flex flex-wrap items-center gap-2 text-xs text-muted-foreground">
              <Badge variant="secondary" className="rounded-full">
                {CATEGORIES.find((c) => c.key === post.category)?.label ?? post.category}
              </Badge>
              <span>{post.anonymous ? "ìµëª…" : post.author}</span>
              <span>â€¢</span>
              <span>{post.createdAt}</span>
              {post.tags?.slice(0, 6).map((t) => (
                <Pill key={t}>#{t}</Pill>
              ))}
            </div>

            <div className="rounded-2xl border p-4 text-sm leading-relaxed">{post.body}</div>

            <div className="flex items-center gap-2">
              <Button
                variant="outline"
                className="rounded-2xl"
                onClick={togglePostLike}
                disabled={!token || likeBusy || serverStatus !== "up"}
              >
                <Heart className="mr-2 h-4 w-4" /> ì¢‹ì•„ìš”
              </Button>
              {!token && (
                <div className="text-xs text-muted-foreground">ë¡œê·¸ì¸í•˜ë©´ ì¢‹ì•„ìš”/ëŒ“ê¸€ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
              )}
              {token && serverStatus !== "up" && (
                <div className="text-xs text-muted-foreground">ì˜¤í”„ë¼ì¸ ëª¨ë“œì—ì„œëŠ” ì¢‹ì•„ìš”/ëŒ“ê¸€ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.</div>
              )}
              <div className="ml-auto text-sm text-muted-foreground">â¤ï¸ {post.likes} Â· ğŸ’¬ {post.comments}</div>
            </div>

            <div className="rounded-2xl bg-muted/40 p-4">
              <div className="flex items-center justify-between">
                <div className="text-sm font-medium">ëŒ“ê¸€</div>
                <div className="text-xs text-muted-foreground">
                  {serverStatus !== "up" ? "ì˜¤í”„ë¼ì¸" : loading ? "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦" : `${comments.length}ê°œ`}
                </div>
              </div>

              <div className="mt-3 space-y-2 max-h-[260px] overflow-auto pr-1">
                {serverStatus === "up" &&
                  comments.map((c) => (
                    <div key={c.commentId} className="rounded-2xl border bg-background p-3">
                      <div className="flex items-center gap-2 text-xs text-muted-foreground">
                        <span>{c.anonymous ? "ìµëª…" : c.authorName}</span>
                        <span>â€¢</span>
                        <span>{c.createdAt}</span>
                        <span className="ml-auto">â¤ï¸ {c.likes}</span>
                      </div>
                      <div className="mt-1 text-sm">{c.body}</div>
                    </div>
                  ))}

                {serverStatus !== "up" && (
                  <div className="text-sm text-muted-foreground">ì„œë²„ ì—°ê²°ì´ ì•ˆ ë˜ì–´ ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
                )}

                {serverStatus === "up" && !loading && comments.length === 0 && (
                  <div className="text-sm text-muted-foreground">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                )}
              </div>

              <div className="mt-3 flex gap-2">
                <Input
                  value={commentText}
                  onChange={(e) => setCommentText(e.target.value)}
                  placeholder="ëŒ“ê¸€ ì‘ì„±"
                  className="rounded-2xl"
                  disabled={!token || serverStatus !== "up"}
                  onKeyDown={(e) => {
                    if (e.key === "Enter") sendComment();
                  }}
                />
                <Button
                  variant={commentAnon ? "default" : "outline"}
                  className="rounded-2xl"
                  onClick={() => setCommentAnon((v) => !v)}
                  disabled={!token || serverStatus !== "up"}
                >
                  ìµëª…
                </Button>
                <Button
                  className="rounded-2xl"
                  onClick={sendComment}
                  disabled={!token || serverStatus !== "up"}
                >
                  ë“±ë¡
                </Button>
              </div>
            </div>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}

function ComposeModal({ onCreate, token, requireLogin, serverStatus, onServerDown }) {
  const [open, setOpen] = useState(false);
  const [category, setCategory] = useState("free");
  const [title, setTitle] = useState("");
  const [body, setBody] = useState("");
  const [anonymous, setAnonymous] = useState(false);

  const reset = () => {
    setCategory("free");
    setTitle("");
    setBody("");
    setAnonymous(false);
  };

  const submit = async () => {
    if (!title.trim() || !body.trim()) return;
    if (requireLogin && !token) return;
    if (serverStatus !== "up") return;

    const r = await apiPostSafe("/posts", {
      token,
      category,
      title,
      body,
      anonymous,
    });

    if (!r.ok) {
      onServerDown?.(r);
      return;
    }

    if (r.data?.ok) {
      onCreate(
        normalizePost({
          postId: r.data.postId || `p_${Date.now()}`,
          category,
          title,
          body,
          authorName: anonymous ? "ìµëª…" : "ë‚˜",
          anonymous,
          createdAt: "ë°©ê¸ˆ",
          tags: "",
          likes: 0,
          comments: 0,
          pinned: false,
          liked: false,
        }),
      );
      setOpen(false);
      reset();
    }
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button className="rounded-2xl" disabled={serverStatus !== "up"}>
          <Plus className="mr-2 h-4 w-4" /> ê¸€ì“°ê¸°
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-xl rounded-2xl">
        <DialogHeader>
          <DialogTitle>ìƒˆ ê¸€ ì‘ì„±</DialogTitle>
        </DialogHeader>
        <div className="space-y-3">
          <div className="flex flex-wrap items-center gap-2">
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="outline" className="rounded-2xl">
                  <Hash className="mr-2 h-4 w-4" />
                  {CATEGORIES.find((c) => c.key === category)?.label}
                  <ChevronDown className="ml-2 h-4 w-4 opacity-60" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="rounded-2xl">
                {CATEGORIES.filter((c) => c.key !== "all").map((c) => (
                  <DropdownMenuItem key={c.key} onClick={() => setCategory(c.key)}>
                    {c.label}
                  </DropdownMenuItem>
                ))}
              </DropdownMenuContent>
            </DropdownMenu>

            <Button
              variant={anonymous ? "default" : "outline"}
              className="rounded-2xl"
              onClick={() => setAnonymous((v) => !v)}
            >
              <User className="mr-2 h-4 w-4" />
              {anonymous ? "ìµëª… ON" : "ìµëª… OFF"}
            </Button>
          </div>

          <Input
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            placeholder="ì œëª©"
            className="rounded-2xl"
          />
          <Textarea
            value={body}
            onChange={(e) => setBody(e.target.value)}
            placeholder="ë‚´ìš©"
            className="min-h-[140px] rounded-2xl"
          />

          <div className="flex items-center justify-end gap-2">
            <Button variant="outline" className="rounded-2xl" onClick={() => setOpen(false)}>
              ì·¨ì†Œ
            </Button>
            <Button className="rounded-2xl" onClick={submit} disabled={!token || serverStatus !== "up"}>
              ë“±ë¡
            </Button>
          </div>

          {requireLogin && !token && (
            <div className="text-xs text-muted-foreground">â€» ê¸€ì“°ê¸°ëŠ” ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
          )}
          {serverStatus !== "up" && (
            <div className="text-xs text-muted-foreground">â€» ì„œë²„ ì—°ê²°ì´ ì•ˆ ë˜ì–´ ê¸€ì“°ê¸°ê°€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.</div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}

function ChatPanel() {
  const [messages, setMessages] = useState(SEED_CHAT);
  const [text, setText] = useState("");

  const send = () => {
    const t = text.trim();
    if (!t) return;
    setMessages((m) => [...m, { id: `c_${Date.now()}`, who: "ë‚˜", text: t, at: "ì§€ê¸ˆ" }]);
    setText("");
  };

  return (
    <Card className="rounded-2xl">
      <CardHeader className="pb-2">
        <div className="flex items-center justify-between">
          <CardTitle className="text-base">ì„œíŠ¹ì˜ ê¹¨í†¡ â€” ì „ì²´ë°©</CardTitle>
          <Badge variant="secondary" className="rounded-full">
            LIVE
          </Badge>
        </div>
      </CardHeader>
      <CardContent className="space-y-3">
        <div className="max-h-[280px] overflow-auto rounded-2xl border p-3">
          <div className="space-y-2">
            {messages.map((m) => (
              <div key={m.id} className="flex items-start gap-2">
                <div className="mt-0.5 w-12 text-xs text-muted-foreground">{m.at}</div>
                <div className="min-w-0">
                  <div className="text-xs text-muted-foreground">{m.who}</div>
                  <div className="rounded-2xl bg-muted/40 px-3 py-2 text-sm">{m.text}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
        <div className="flex gap-2">
          <Input
            value={text}
            onChange={(e) => setText(e.target.value)}
            placeholder="ë©”ì‹œì§€ ë³´ë‚´ê¸°"
            className="rounded-2xl"
            onKeyDown={(e) => {
              if (e.key === "Enter") send();
            }}
          />
          <Button className="rounded-2xl" onClick={send}>
            ì „ì†¡
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}

function InfoPanel({ reputation = 50, phase = "ì„ì‹œ Cê¸‰" }) {
  return (
    <Card className="rounded-2xl">
      <CardHeader className="pb-2">
        <CardTitle className="text-base">INFO</CardTitle>
      </CardHeader>
      <CardContent className="space-y-3">
        <div className="grid grid-cols-2 gap-2">
          <StatChip icon={Star} label="í‰íŒ" value={reputation} />
          <StatChip icon={Sparkles} label="ë“±ê¸‰" value={phase} />
          <StatChip icon={Shield} label="ì œì–´ê¸°" value="ON" />
          <StatChip icon={Calendar} label="ì˜¤ëŠ˜" value="ì…í•™ 1ì¼ì°¨" />
        </div>
        <div className="rounded-2xl border p-3 text-sm">
          <div className="text-xs text-muted-foreground">ì˜¤ëŠ˜ì˜ í•« í‚¤ì›Œë“œ</div>
          <div className="mt-2 flex flex-wrap gap-2">
            {["#ì•„ì´ë¦¬ìŠ¤", "#ì „í•™ìƒ", "#ê¸‰ì‹", "#ì‹¤ì „í‰ê°€", "#ìœ„ìƒì„ "].map((t) => (
              <Badge key={t} variant="secondary" className="rounded-full">
                {t}
              </Badge>
            ))}
          </div>
        </div>
        <div className="rounded-2xl bg-muted/40 p-3 text-sm">
          <div className="text-xs text-muted-foreground">ìš´ì˜ ë©”ëª¨</div>
          <div className="mt-1">ê³µì§€/ì¼ì •ì€ í•™ìƒíšŒê°€, ë„ê°ì€ ë„ê°ë´‡ì´ ìë™ ê°±ì‹ í•©ë‹ˆë‹¤.</div>
        </div>
      </CardContent>
    </Card>
  );
}

export default function App() {
  // ì„œë²„ ìƒíƒœ: unknown | up | down
  const [serverStatus, setServerStatus] = useState("unknown");
  const [lastNetError, setLastNetError] = useState("");
  const [lastNetUrl, setLastNetUrl] = useState("");

  const [token, setToken] = useState(() => localStorage.getItem("srt_token") || "");
  const [me, setMe] = useState(null);

  // ë¡œê·¸ì¸ ëª¨ë‹¬
  const [loginOpen, setLoginOpen] = useState(false);
  const [studentId, setStudentId] = useState("");
  const [displayName, setDisplayName] = useState("");

  const [activeCat, setActiveCat] = useState("all");
  const [query, setQuery] = useState("");
  const [sort, setSort] = useState("hot");

  const [posts, setPosts] = useState(SEED_POSTS.map(normalizePost));
  const [openPost, setOpenPost] = useState(null);

  const markServerDown = React.useCallback((result) => {
    setServerStatus("down");
    setLastNetError(result?.error || "Failed to fetch");
    setLastNetUrl(result?._url || "");
  }, []);

  const pingServer = React.useCallback(async () => {
    const r = await apiGetSafe("/health");
    if (!r.ok) {
      markServerDown(r);
      return false;
    }
    if (r.data?.ok) {
      setServerStatus("up");
      setLastNetError("");
      setLastNetUrl("");
      return true;
    }
    markServerDown({ ok: false, error: "Invalid response", _url: r._url });
    return false;
  }, [markServerDown]);

  React.useEffect(() => {
    pingServer();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  async function doLogin() {
    const sid = studentId.trim();
    const nm = displayName.trim() || "í•™ìƒ";
    if (!sid) return;
    if (serverStatus !== "up") return;

    const r = await apiPostSafe("/auth/login", { studentId: sid, name: nm });
    if (!r.ok) {
      markServerDown(r);
      return;
    }
    if (r.data?.ok && r.data.sessionToken) {
      localStorage.setItem("srt_token", r.data.sessionToken);
      setToken(r.data.sessionToken);
      setLoginOpen(false);
    }
  }

  async function doLogout() {
    if (token && serverStatus === "up") await apiPostSafe("/auth/logout", { token });
    localStorage.removeItem("srt_token");
    setToken("");
    setMe(null);
  }

  React.useEffect(() => {
    let mounted = true;
    (async () => {
      if (!token || serverStatus !== "up") return;
      const r = await apiGetSafe("/auth/me", { token });
      if (!mounted) return;
      if (!r.ok) {
        markServerDown(r);
        return;
      }
      if (r.data?.ok) setMe(r.data.user);
    })();
    return () => {
      mounted = false;
    };
  }, [token, serverStatus, markServerDown]);

  const fetchPosts = React.useCallback(async () => {
    if (serverStatus !== "up") return;
    const r = await apiGetSafe("/posts", {
      category: activeCat,
      sort,
      q: query,
      token: token || "",
    });
    if (!r.ok) {
      markServerDown(r);
      return;
    }
    if (r.data?.ok && Array.isArray(r.data.posts)) {
      setPosts(r.data.posts.map(normalizePost));
    }
  }, [activeCat, sort, query, token, serverStatus, markServerDown]);

  React.useEffect(() => {
    if (serverStatus === "up") fetchPosts();
  }, [fetchPosts, serverStatus]);

  const filtered = useMemo(() => {
    let list = [...posts];
    if (activeCat !== "all") list = list.filter((p) => p.category === activeCat);

    const q = query.trim().toLowerCase();
    if (q) {
      list = list.filter((p) =>
        [p.title, p.body, ...(p.tags ?? [])].join(" ").toLowerCase().includes(q),
      );
    }

    if (sort === "hot") list.sort((a, b) => b.likes + b.comments - (a.likes + a.comments));
    else list.sort((a, b) => (a.createdAt < b.createdAt ? 1 : -1));

    list.sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));
    return list;
  }, [posts, activeCat, query, sort]);

  const onCreate = (p) => setPosts((prev) => [normalizePost(p), ...prev]);

  const retryAll = async () => {
    const ok = await pingServer();
    if (ok) await fetchPosts();
  };

  return (
    <div className="min-h-screen bg-background">
      <OfflineBanner status={serverStatus} lastError={lastNetError} lastUrl={lastNetUrl} onRetry={retryAll} />

      <header className="sticky top-0 z-30 border-b bg-background/80 backdrop-blur">
        <Dialog open={loginOpen} onOpenChange={setLoginOpen}>
          <DialogContent className="max-w-md rounded-2xl">
            <DialogHeader>
              <DialogTitle>ì„œíŠ¹ì˜ ë¡œê·¸ì¸ (í•™ë²ˆ ì¸ì¦)</DialogTitle>
            </DialogHeader>
            <div className="space-y-3">
              <Input
                value={studentId}
                onChange={(e) => setStudentId(e.target.value)}
                placeholder="í•™ë²ˆ (ì˜ˆ: 2035-101)"
                className="rounded-2xl"
              />
              <Input
                value={displayName}
                onChange={(e) => setDisplayName(e.target.value)}
                placeholder="ë‹‰ë„¤ì„/ì´ë¦„ (í‘œì‹œìš©)"
                className="rounded-2xl"
              />
              <div className="flex justify-end gap-2">
                <Button variant="outline" className="rounded-2xl" onClick={() => setLoginOpen(false)}>
                  ë‹«ê¸°
                </Button>
                <Button className="rounded-2xl" onClick={doLogin} disabled={serverStatus !== "up"}>
                  ë¡œê·¸ì¸
                </Button>
              </div>
              <div className="text-xs text-muted-foreground">â€» í† í°ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤. (LocalStorage)</div>
              {serverStatus !== "up" && (
                <div className="text-xs text-muted-foreground">
                  â€» ì„œë²„ ì—°ê²°ì´ ì•ˆ ë˜ì–´ ë¡œê·¸ì¸/ì €ì¥ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.
                </div>
              )}
            </div>
          </DialogContent>
        </Dialog>

        <div className="mx-auto flex max-w-7xl items-center justify-between gap-3 px-4 py-3">
          <div className="flex items-center gap-3">
            <div className="h-10 w-10 rounded-2xl border flex items-center justify-center">
              <Sparkles className="h-5 w-5" />
            </div>
            <div>
              <div className="text-sm text-muted-foreground">ì„œìš¸ì‹œ íŠ¹ì´ëŠ¥ë ¥ ì˜ì¬í•™êµ</div>
              <div className="text-lg font-semibold leading-tight">ì„œíŠ¹ì˜ ì»¤ë®¤ë‹ˆí‹°</div>
            </div>
          </div>

          <div className="hidden md:flex items-center gap-2">
            <div className="relative w-[360px]">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
              <Input
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder="ê³µì§€, ê¸‰ì‹, ì•„ì´ë¦¬ìŠ¤, ìœ„ìƒì„ â€¦"
                className="pl-9 rounded-2xl"
              />
            </div>

            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="outline" className="rounded-2xl">
                  <Filter className="mr-2 h-4 w-4" />
                  {sort === "hot" ? "ì¸ê¸°ìˆœ" : "ìµœì‹ ìˆœ"}
                  <ChevronDown className="ml-2 h-4 w-4 opacity-60" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="rounded-2xl">
                <DropdownMenuItem onClick={() => setSort("hot")}>ì¸ê¸°ìˆœ</DropdownMenuItem>
                <DropdownMenuItem onClick={() => setSort("latest")}>ìµœì‹ ìˆœ</DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>

            <ComposeModal
              onCreate={onCreate}
              token={token}
              requireLogin={true}
              serverStatus={serverStatus}
              onServerDown={markServerDown}
            />
          </div>

          <div className="hidden md:flex items-center gap-2">
            {token ? (
              <>
                <Badge variant="secondary" className="rounded-full">
                  {me?.name || "ë¡œê·¸ì¸ë¨"}
                </Badge>
                <Button variant="outline" className="rounded-2xl" onClick={doLogout}>
                  ë¡œê·¸ì•„ì›ƒ
                </Button>
              </>
            ) : (
              <Button className="rounded-2xl" onClick={() => setLoginOpen(true)}>
                ë¡œê·¸ì¸
              </Button>
            )}
            <Badge variant="secondary" className="rounded-full">
              {serverStatus === "up" ? "ì„œë²„ ON" : serverStatus === "down" ? "ì˜¤í”„ë¼ì¸" : "ì—°ê²°ì¤‘"}
            </Badge>
          </div>

          <div className="md:hidden flex items-center gap-2">
            {token ? (
              <Button variant="outline" className="rounded-2xl" onClick={doLogout}>
                ë¡œê·¸ì•„ì›ƒ
              </Button>
            ) : (
              <Button className="rounded-2xl" onClick={() => setLoginOpen(true)}>
                ë¡œê·¸ì¸
              </Button>
            )}
            <ComposeModal
              onCreate={onCreate}
              token={token}
              requireLogin={true}
              serverStatus={serverStatus}
              onServerDown={markServerDown}
            />
          </div>
        </div>
      </header>

      <main className="mx-auto grid max-w-7xl grid-cols-1 gap-4 px-4 py-4 md:grid-cols-12">
        <aside className="md:col-span-3">
          <Card className="rounded-2xl">
            <CardHeader className="pb-2">
              <CardTitle className="text-base">ê²Œì‹œíŒ</CardTitle>
            </CardHeader>
            <CardContent className="space-y-2">
              {CATEGORIES.map((cat) => (
                <CategoryItem
                  key={cat.key}
                  cat={cat}
                  active={activeCat === cat.key}
                  onClick={() => setActiveCat(cat.key)}
                />
              ))}
            </CardContent>
          </Card>

          <div className="mt-4 hidden md:block">
            <InfoPanel />
          </div>
        </aside>

        <section className="md:col-span-6">
          <div className="mb-3 md:hidden">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
              <Input
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder="ê³µì§€, ê¸‰ì‹, ì•„ì´ë¦¬ìŠ¤, ìœ„ìƒì„ â€¦"
                className="pl-9 rounded-2xl"
              />
            </div>
            <div className="mt-2 flex items-center justify-between">
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button variant="outline" className="rounded-2xl">
                    <Filter className="mr-2 h-4 w-4" />
                    {sort === "hot" ? "ì¸ê¸°ìˆœ" : "ìµœì‹ ìˆœ"}
                    <ChevronDown className="ml-2 h-4 w-4 opacity-60" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent className="rounded-2xl">
                  <DropdownMenuItem onClick={() => setSort("hot")}>ì¸ê¸°ìˆœ</DropdownMenuItem>
                  <DropdownMenuItem onClick={() => setSort("latest")}>ìµœì‹ ìˆœ</DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
              <Badge variant="secondary" className="rounded-full">
                {filtered.length}ê°œ
              </Badge>
            </div>
          </div>

          <div className="flex items-center justify-between">
            <div className="text-sm text-muted-foreground">
              {activeCat === "all" ? "ì „ì²´ í”¼ë“œ" : CATEGORIES.find((c) => c.key === activeCat)?.label}
              {query.trim() ? ` â€¢ ê²€ìƒ‰: â€œ${query.trim()}â€` : ""}
            </div>
            <div className="flex items-center gap-2">
              <Badge variant="secondary" className="rounded-full">
                <Flame className="mr-1 h-3 w-3" /> HOT
              </Badge>
              <Button variant="outline" className="rounded-2xl" onClick={retryAll} title="ì„œë²„ ì¬ì—°ê²°/ìƒˆë¡œê³ ì¹¨">
                ìƒˆë¡œê³ ì¹¨
              </Button>
            </div>
          </div>

          <div className="mt-3 space-y-3">
            <AnimatePresence>
              {filtered.map((post) => (
                <PostCard key={post.id} post={post} onOpen={setOpenPost} />
              ))}
            </AnimatePresence>
          </div>

          <PostModal
            open={!!openPost}
            onOpenChange={(v) => {
              if (!v) setOpenPost(null);
            }}
            post={openPost}
            token={token}
            serverStatus={serverStatus}
            onRefreshPost={fetchPosts}
            onServerDown={markServerDown}
          />

          <div className="mt-4 md:hidden">
            <InfoPanel />
          </div>
        </section>

        <aside className="md:col-span-3 space-y-4">
          <ChatPanel />

          <Card className="rounded-2xl">
            <CardHeader className="pb-2">
              <CardTitle className="text-base">ì˜¤ëŠ˜ì˜ ì´ë²¤íŠ¸</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div className="rounded-2xl border p-3">
                <div className="flex items-center justify-between">
                  <div className="font-medium">ìœ„ìƒ ê³µëª… ê¸°ì´ˆ í…ŒìŠ¤íŠ¸</div>
                  <Badge className="rounded-full">09:10</Badge>
                </div>
                <div className="mt-1 text-sm text-muted-foreground">ë³¸ê´€ 2ì¸µ ì¸¡ì •ì‹¤. ì œì–´ê¸° ìƒíƒœ í™•ì¸.</div>
              </div>
              <div className="rounded-2xl border p-3">
                <div className="flex items-center justify-between">
                  <div className="font-medium">7êµì‹œ ì‹¤ì „í‰ê°€</div>
                  <Badge variant="secondary" className="rounded-full">
                    15:30
                  </Badge>
                </div>
                <div className="mt-1 text-sm text-muted-foreground">ì „ì› ì°¸ì—¬. ì¥ë¹„ ì ê²€ í•„ìˆ˜.</div>
              </div>
              <div className="rounded-2xl bg-muted/40 p-3 text-sm">
                <div className="flex items-center gap-2">
                  <Bell className="h-4 w-4" />
                  <span className="text-muted-foreground">ì•Œë¦¼: ê³µì§€ ê²Œì‹œíŒ ê³ ì •ê¸€ í™•ì¸</span>
                </div>
              </div>
            </CardContent>
          </Card>
        </aside>
      </main>

      <footer className="border-t">
        <div className="mx-auto max-w-7xl px-4 py-6 text-xs text-muted-foreground">
          â€» Google Sheetsë¥¼ ì„œë²„ì²˜ëŸ¼ ì“°ëŠ” MVPì…ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ê°€ ë§‰íŒ í™˜ê²½ì—ì„œëŠ” ìë™ìœ¼ë¡œ ì˜¤í”„ë¼ì¸(ëª©ì—…) ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.
        </div>
      </footer>
    </div>
  );
}
